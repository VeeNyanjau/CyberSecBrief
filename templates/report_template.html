<!DOCTYPE html>
<html>

<head>
    <style>
        /* PDF Specific CSS for xhtml2pdf */
        /* Explicitly link 'main_template' to the default layout */
        @page main_template {
            size: A4;
            margin: 2cm;

            /* Define a footer frame */
            @frame footer_frame {
                -pdf-frame-content: footerContent;
                bottom: 1cm;
                margin-left: 2cm;
                margin-right: 2cm;
                height: 1cm;
            }
        }

        /* Define a specific template for the cover page with no footer */
        @page cover_template {
            margin: 0cm;
            /* No footer frame defined here, so it should be blank */
        }

        body {
            font-family: Helvetica, sans-serif;
            line-height: 1.5;
            color: #2c3e50;
        }

        /* Footer Content */
        #footerContent {
            text-align: center;
            font-size: 10pt;
            color: #7f8c8d;
        }

        /* Cover Page Styling */
        .cover-page {
            text-align: center;
            padding-top: 30%;
        }

        .cover-title {
            font-size: 48pt;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .cover-subtitle {
            font-size: 24pt;
            color: #7f8c8d;
            margin-bottom: 50px;
        }

        .cover-date {
            font-size: 14pt;
            color: #34495e;
            margin-top: 100px;
        }

        /* Executive Summary & Signals Styling */
        .exec-summary-box {
            background-color: #f8f9fa;
            border-left: 5px solid #3498db;
            padding: 20px;
            margin-bottom: 30px;
            page-break-after: always;
        }

        .section-header {
            font-size: 18pt;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .signal-grid {
            margin-bottom: 30px;
        }

        .signal-card {
            background-color: #eafaf1;
            border: 1px solid #d5f5e3;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .signal-title {
            font-weight: bold;
            color: #27ae60;
            font-size: 12pt;
            margin-bottom: 5px;
        }

        /* TOC Styling */
        pdftoc {
            color: #000;
        }

        pdftoc a {
            color: #000;
            text-decoration: none;
        }

        /* Content Styling */
        h1 {
            color: #2c3e50;
            font-size: 24pt;
            margin-top: 0;
            margin-bottom: 20px;
        }

        h2.cat-header {
            color: #2c3e50;
            font-size: 20pt;
            margin-bottom: 15px;
            padding-top: 20px;
            /* Force new page before category */
            page-break-before: always;
        }

        .story {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #bdc3c7;
            /* Prevent breaking stories across pages if possible */
            page-break-inside: avoid;
        }

        .story-title {
            font-size: 14pt;
            font-weight: bold;
            color: #2980b9;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }

        .story-meta {
            font-size: 9pt;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .summary {
            font-size: 11pt;
            text-align: justify;
        }

        .why-box {
            background-color: #fff8e1;
            border-left: 4px solid #f1c40f;
            padding: 10px;
            margin-top: 10px;
            font-size: 10pt;
            font-style: italic;
            color: #5d4037;
        }

        .research-tag {
            display: inline-block;
            background-color: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 8pt;
            margin-left: 10px;
            vertical-align: middle;
        }

        .empty-state {
            font-style: italic;
            color: #95a5a6;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <!-- Footer Content (hidden in flow, used by frame) -->
    <div id="footerContent">
        Generated by CyberSecBrief &bull; Page
        <pdf:pagenumber />
    </div>

    <!-- Start with Cover Template -->
    <pdf:nexttemplate name="cover_template" />
    <div class="cover-page">
        <div class="cover-title">CyberSecBrief</div>
        <div class="cover-subtitle">Cybersecurity Trends, Research & Project Ideas</div>
        <div class="cover-date">{{ date }}</div>
    </div>

    <!-- Switch to Main Template -->
    <pdf:nexttemplate name="main_template" />
    <div style="page-break-after: always;"></div>

    <!-- 2. Executive Summary & Signals (New Page) -->
    {% if insights.executive_summary or insights.signals %}
    <div class="exec-summary-box">
        <div class="section-header">Executive Insight Summary</div>
        <p>{{ insights.executive_summary }}</p>
    </div>

    <div class="section-header">Signals & Patterns</div>
    <div class="signal-grid">
        {% for signal in insights.signals %}
        <div class="signal-card">
            <div class="signal-title">SIGNAL {{ loop.index }}: {{ signal.title }}</div>
            <div>{{ signal.description }}</div>
        </div>
        {% endfor %}
    </div>

    <div style="page-break-after: always;"></div>
    {% endif %}

    <!-- 3. Table of Contents -->
    <h1>Table of Contents</h1>
    <div>
        <pdf:toc />
    </div>

    <div style="page-break-after: always;"></div>

    <!-- 4. Content Sections -->
    {% set categories = [
    'Emerging Threats & Attack Patterns',
    'Defensive Techniques & Blue Team Strategies',
    'Tools, Frameworks & Open-Source Spotlight',
    'Academic Research & Papers',
    'Vulnerabilities & Exploit Analysis',
    'Security Failures & Postmortems',
    'Ethics, Law & Policy in Cybersecurity',
    'AI, Automation & Cybersecurity',
    'Sector-Specific Security'
    ] %}

    {% for category_name in categories %}
    <h2 class="cat-header">{{ category_name }}</h2>

    {% if stories[category_name] %}
    {% for story in stories[category_name] %}
    <div class="story">
        <div>
            <a href="{{ story.link }}" class="story-title">{{ story.title }}</a>
            {% if story.research_tag and story.research_tag != 'General' %}
            <span class="research-tag">{{ story.research_tag }}</span>
            {% endif %}
        </div>
        <div class="story-meta">
            {{ story.source }} | {{ story.published.strftime('%Y-%m-%d') }}
        </div>
        <div class="summary">{{ story.clean_summary }}</div>

        {% if story.why_it_matters %}
        <div class="why-box">
            <strong>Why This Matters:</strong> {{ story.why_it_matters }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">No significant updates in this category today.</div>
    {% endif %}

    {% endfor %}

</body>

</html>